if(typeof require!="undefined"){var _=require("./underscore-min")}var DesSerializadorDeFiltros={desSerializarFiltro:function(un_filtro_serializado){var filtro;switch(un_filtro_serializado.tipo){case"EX":filtro=new FiltroXEjemplo;break;case"EQ":filtro=new FiltroXClaveValor;break;case"AND":filtro=new FiltroAND;break;case"OR":filtro=new FiltroOR;break;case"TRUE":filtro=new FiltroTrue;break;case"FALSE":filtro=new FiltroFalse;break;default:filtro=new FiltroDesconocido}filtro.desSerializar(un_filtro_serializado);return filtro}};if(typeof require!="undefined"){exports.DesSerializadorDeFiltros=DesSerializadorDeFiltros}var FiltroXEjemplo=function(ejemplo){this.ejemplo=ejemplo};FiltroXEjemplo.prototype={eval:function(un_mensaje){return _.isMatch(un_mensaje,this.ejemplo)},serializar:function(){return{tipo:"EX",ejemplo:this.ejemplo}},desSerializar:function(un_filtro_serializado){this.ejemplo=un_filtro_serializado.ejemplo},simplificar:function(){return this},equals:function(otro_filtro){if(!(otro_filtro instanceof FiltroXEjemplo))return false;return _.isEqual(this.ejemplo,otro_filtro.ejemplo)},contains:function(otro_filtro){if(otro_filtro instanceof FiltroXEjemplo)return _.isMatch(otro_filtro.ejemplo,this.ejemplo);if(otro_filtro instanceof FiltroFalse)return true;return false}};if(typeof require!="undefined"){exports.FiltroXEjemplo=FiltroXEjemplo}var FiltroXClaveValor=function(clave,valor){this._clave=clave;this._valor=valor};FiltroXClaveValor.prototype={eval:function(un_mensaje){return un_mensaje[this._clave]==this._valor},serializar:function(){return{tipo:"EQ",clave:this._clave,valor:this._valor}},desSerializar:function(un_filtro_serializado){this._clave=un_filtro_serializado.clave;this._valor=un_filtro_serializado.valor},simplificar:function(){return this},equals:function(otro_filtro){if(!(otro_filtro instanceof FiltroXClaveValor))return false;return this._clave==otro_filtro._clave&&this._valor==otro_filtro._valor},contains:function(otro_filtro){if(otro_filtro instanceof FiltroXClaveValor)return this._clave==otro_filtro._clave&&this._valor==otro_filtro._valor;if(otro_filtro instanceof FiltroXEjemplo){if(otro_filtro.ejemplo[this._clave]==this._valor)return true}if(otro_filtro instanceof FiltroFalse)return true;return false}};if(typeof require!="undefined"){exports.FiltroXClaveValor=FiltroXClaveValor}var FiltroAND=function(_filtros){this.filtros=_filtros===undefined?[]:_filtros};FiltroAND.prototype={eval:function(un_mensaje){var valorRetorno=true;for(var i=0;i<this.filtros.length;i++){var evaluacion=this.filtros[i].eval(un_mensaje);if(evaluacion==false){return false}if(evaluacion===undefined){valorRetorno=undefined}}return valorRetorno},serializar:function(){var ret={tipo:"AND",filtros:[]};for(var i=0;i<this.filtros.length;i++){ret.filtros.push(this.filtros[i].serializar())}return ret},desSerializar:function(un_filtro_serializado){for(var i=0;i<un_filtro_serializado.filtros.length;i++){this.filtros.push(DesSerializadorDeFiltros.desSerializarFiltro(un_filtro_serializado.filtros[i]))}},simplificar:function(){var filtros_acumulados_simplificados=[];for(var i=0;i<this.filtros.length;i++){if(this.filtros[i]instanceof FiltroAND){for(var j=0;j<this.filtros[i].filtros.length;j++){filtros_acumulados_simplificados.push(this.filtros[i].filtros[j].simplificar())}}else{filtros_acumulados_simplificados.push(this.filtros[i].simplificar())}}var filtros_sin_true=[];for(var i=0;i<filtros_acumulados_simplificados.length;i++){if(filtros_acumulados_simplificados[i]instanceof FiltroFalse)return filtros_acumulados_simplificados[i];if(!(filtros_acumulados_simplificados[i]instanceof FiltroTrue))filtros_sin_true.push(filtros_acumulados_simplificados[i])}if(filtros_sin_true.length==1)return filtros_sin_true[0];if(filtros_sin_true.length==0)return new FiltroFalse;return new FiltroAND(filtros_sin_true).eliminarDuplicados()},eliminarDuplicados:function(){var filtro_sin_duplicados=new FiltroAND;for(var i=0;i<this.filtros.length;i++){if(!filtro_sin_duplicados.incluyeElFiltro(this.filtros[i])){filtro_sin_duplicados.filtros.push(this.filtros[i])}}return filtro_sin_duplicados},incluyeElFiltro:function(un_filtro){for(var i=0;i<this.filtros.length;i++){if(this.filtros[i].equals(un_filtro))return true}return false},equals:function(otro_filtro){if(!(otro_filtro instanceof FiltroAND))return false;if(otro_filtro.filtros.length!=this.filtros.length)return false;for(var i=0;i<this.filtros.length;i++){if(!otro_filtro.incluyeElFiltro(this.filtros[i]))return false}return true},contains:function(otro_filtro){if(otro_filtro instanceof FiltroXClaveValor)return this._clave==otro_filtro._clave&&this._valor==otro_filtro._valor;if(otro_filtro instanceof FiltroXEjemplo){if(otro_filtro.ejemplo[this._clave]==this._valor)return true}if(otro_filtro instanceof FiltroFalse)return true;return false}};if(typeof require!="undefined"){exports.FiltroAND=FiltroAND}var FiltroOR=function(_filtros){this.filtros=_filtros===undefined?[]:_filtros};FiltroOR.prototype={eval:function(un_mensaje){var valorRetorno=false;for(var i=0;i<this.filtros.length;i++){var evaluacion=this.filtros[i].eval(un_mensaje);if(evaluacion==true){return true}if(evaluacion===undefined){valorRetorno=undefined}}return valorRetorno},serializar:function(){var ret={tipo:"OR",filtros:[]};for(var i=0;i<this.filtros.length;i++){ret.filtros.push(this.filtros[i].serializar())}return ret},desSerializar:function(un_filtro_serializado){for(var i=0;i<un_filtro_serializado.filtros.length;i++){this.filtros.push(DesSerializadorDeFiltros.desSerializarFiltro(un_filtro_serializado.filtros[i]))}},simplificar:function(){var filtros_acumulados_simplificados=[];for(var i=0;i<this.filtros.length;i++){var filtro_simplificado=this.filtros[i].simplificar();if(filtro_simplificado instanceof FiltroOR){for(var j=0;j<filtro_simplificado.filtros.length;j++){filtros_acumulados_simplificados.push(filtro_simplificado.filtros[j])}}else{filtros_acumulados_simplificados.push(filtro_simplificado)}}var filtros_mas_generales=_.where(filtros_acumulados_simplificados);_.forEach(filtros_acumulados_simplificados,function(filtro1){_.forEach(filtros_acumulados_simplificados,function(filtro2){if(filtro1===filtro2)return;if(!_.contains(filtros_mas_generales,filtro1))return;if(!_.contains(filtros_mas_generales,filtro2))return;if(!filtro1.contains(filtro2))return;filtros_mas_generales=_.reject(filtros_mas_generales,function(f){return f===filtro2})})});if(filtros_mas_generales.length==1)return filtros_mas_generales[0];if(filtros_mas_generales.length==0)return new FiltroFalse;return new FiltroOR(filtros_mas_generales)},eliminarDuplicados:function(){var filtro_sin_duplicados=new FiltroOR;for(var i=0;i<this.filtros.length;i++){if(!filtro_sin_duplicados.incluyeElFiltro(this.filtros[i])){filtro_sin_duplicados.filtros.push(this.filtros[i])}}return filtro_sin_duplicados},incluyeElFiltro:function(un_filtro){for(var i=0;i<this.filtros.length;i++){if(this.filtros[i].equals(un_filtro))return true}return false},equals:function(otro_filtro){if(!(otro_filtro instanceof FiltroOR))return false;if(otro_filtro.filtros.length!=this.filtros.length)return false;for(var i=0;i<this.filtros.length;i++){if(!otro_filtro.incluyeElFiltro(this.filtros[i]))return false}return true},contains:function(otro_filtro){return false}};if(typeof require!="undefined"){exports.FiltroOR=FiltroOR}var FiltroDesconocido=function(){this.version_serializada={tipo:"?"}};FiltroDesconocido.prototype={eval:function(un_mensaje){return undefined},onChange:function(observador){this._observador=observador},serializar:function(){return this.version_serializada},desSerializar:function(un_filtro_serializado){this.version_serializada=un_filtro_serializado},simplificar:function(){return this},contains:function(otro_filtro){return false}};if(typeof require!="undefined"){exports.FiltroDesconocido=FiltroDesconocido}var FiltroTrue=function(){};FiltroTrue.prototype={eval:function(un_mensaje){return true},onChange:function(observador){this._observador=observador},serializar:function(){var ret={tipo:"TRUE"};return ret},desSerializar:function(un_filtro_serializado){},simplificar:function(){return this},equals:function(otro_filtro){return otro_filtro instanceof FiltroTrue},contains:function(otro_filtro){return true}};if(typeof require!="undefined"){exports.FiltroTrue=FiltroTrue}var FiltroFalse=function(){};FiltroFalse.prototype={eval:function(un_mensaje){return false},onChange:function(observador){this._observador=observador},serializar:function(){var ret={tipo:"FALSE"};return ret},desSerializar:function(un_filtro_serializado){},simplificar:function(){return this},equals:function(otro_filtro){return otro_filtro instanceof FiltroFalse},contains:function(otro_filtro){return otro_filtro instanceof FiltroFalse}};if(typeof require!="undefined"){exports.FiltroFalse=FiltroFalse}if(typeof require!="undefined"){var Filtros=require("./Filtros");var _=require("./underscore-min");var FiltroOR=Filtros.FiltroOR;var FiltroAND=Filtros.FiltroAND;var FiltroFalse=Filtros.FiltroFalse;var FiltroXEjemplo=Filtros.FiltroXEjemplo;var DesSerializadorDeFiltros=Filtros.DesSerializadorDeFiltros}var NodoRouter=function(){this.datosVecinos=[];this.pedidos=[];this.proximoIdPedido=0};NodoRouter.prototype.send=function(un_mensaje,callback){if(callback){un_mensaje.idRequest=this.randomString(32);var pedido=this.when({tipoDeMensaje:"Vortex.respuesta",responseTo:un_mensaje.idRequest},function(respuesta){callback(respuesta);pedido.remove()})}_.forEach(this.pedidos,function(un_pedido){if(un_pedido.filtro.eval(un_mensaje)){setTimeout(function(){un_pedido.callback(un_mensaje)},0)}});_.forEach(this.datosVecinos,function(datos_de_un_vecino){if(datos_de_un_vecino.filtroRecibido.eval(un_mensaje)){setTimeout(function(){datos_de_un_vecino.vecino.recibirMensaje(un_mensaje,this)},0)}})};NodoRouter.prototype.when=function(filtro,callback){if(!filtro.eval)filtro=new FiltroXEjemplo(filtro);var id_pedido=this.proximoIdPedido;this.proximoIdPedido+=1;var _this=this;var pedido={id:id_pedido,filtro:filtro,callback:callback,remove:function(){_this.quitarPedido(id_pedido)}};this.pedidos.push(pedido);this.publicarFiltros();return pedido};NodoRouter.prototype.quitarPedido=function(id_pedido){this.pedidos=_.filter(this.pedidos,function(pedido){return pedido.id!=id_pedido});this.publicarFiltros()};NodoRouter.prototype.recibirMensaje=function(un_mensaje,vecino_emisor){var _this=this;if(un_mensaje.tipoDeMensaje){if(un_mensaje.tipoDeMensaje=="Vortex.Filtro.Publicacion"){var datos_del_vecino_emisor=_.find(this.datosVecinos,function(datos_de_un_vecino){return datos_de_un_vecino.vecino===vecino_emisor});if(!datos_del_vecino_emisor)return;datos_del_vecino_emisor.filtroRecibido=DesSerializadorDeFiltros.desSerializarFiltro(un_mensaje.filtro);this.publicarFiltros();return}}_.forEach(this.datosVecinos,function(datos_de_un_vecino){if(vecino_emisor===datos_de_un_vecino.vecino)return;if(datos_de_un_vecino.filtroRecibido.eval(un_mensaje)){setTimeout(function(){datos_de_un_vecino.vecino.recibirMensaje(un_mensaje,this)},0)}});_.forEach(this.pedidos,function(un_pedido){if(un_pedido.filtro.eval(un_mensaje)){setTimeout(function(){un_pedido.callback(un_mensaje)},0)}})};NodoRouter.prototype.conectarCon=function(un_vecino){var datos_del_vecino=_.find(this.datosVecinos,function(datos_de_un_vecino){return datos_de_un_vecino.vecino===un_vecino});if(datos_del_vecino)return;var datos_del_vecino={vecino:un_vecino,filtroRecibido:new FiltroFalse,filtroEnviado:new FiltroFalse};this.datosVecinos.push(datos_del_vecino);this.publicarFiltrosAUnVecino(datos_del_vecino);un_vecino.conectarCon(this)};NodoRouter.prototype.publicarFiltrosAUnVecino=function(datos_del_vecino){var filtros_para_el_vecino=[];_.forEach(this.datosVecinos,function(datos_de_un_vecino){if(datos_del_vecino===datos_de_un_vecino)return;filtros_para_el_vecino.push(datos_de_un_vecino.filtroRecibido)});_.forEach(this.pedidos,function(un_pedido){filtros_para_el_vecino.push(un_pedido.filtro)});var filtro_a_publicar_al_vecino=new FiltroOR(filtros_para_el_vecino).simplificar();if(filtro_a_publicar_al_vecino.equals(datos_del_vecino.filtroEnviado))return;datos_del_vecino.filtroEnviado=filtro_a_publicar_al_vecino;var publicacion_de_filtro={tipoDeMensaje:"Vortex.Filtro.Publicacion",filtro:filtro_a_publicar_al_vecino.serializar()};var _this=this;setTimeout(function(){datos_del_vecino.vecino.recibirMensaje(publicacion_de_filtro,_this)},0)};NodoRouter.prototype.publicarFiltros=function(){var _this=this;_.forEach(this.datosVecinos,function(datos_de_un_vecino){_this.publicarFiltrosAUnVecino(datos_de_un_vecino)})};NodoRouter.prototype.desconectarDe=function(un_vecino){this.datosVecinos=_.filter(this.datosVecinos,function(datos_de_un_vecino){return datos_de_un_vecino.vecino!==un_vecino});this.publicarFiltros()};NodoRouter.prototype.randomString=function(length){var chars="0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ";var result="";for(var i=length;i>0;--i)result+=chars[Math.round(Math.random()*(chars.length-1))];return result};if(typeof require!="undefined"){exports.clase=NodoRouter}if(typeof require!="undefined"){var NodoNulo=require("./NodoNulo").clase}var NodoClienteHTTP=function(url,intervalo_polling,verbose,mensajes_por_paquete){this.url=url;this.intervalo_polling=intervalo_polling===undefined?1500:intervalo_polling;this.verbose=verbose||false;this.mensajes_por_paquete=mensajes_por_paquete||100;this.start()};NodoClienteHTTP.prototype.start=function(){this.intervaloPedidoIdSesion=5e3;this.bandejaSalida=[];this.vecino=new NodoNulo;this.pedirIdSesion()};NodoClienteHTTP.prototype.pedirIdSesion=function(){var _this=this;$.ajax({type:"POST",url:_this.url+"/create",xhrFields:{withCredentials:false},success:function(responseData,textStatus,jqXHR){_this.idSesion=responseData;if(_this.verbose)console.log("idSesion:",_this.idSesion);setTimeout(function(){_this.enviarYRecibirMensajes()},_this.intervaloPolling)},error:function(request,error){console.log("errorAlPedirSesion:",error);setTimeout(function(){_this.pedirIdSesion()},_this.intervaloPedidoIdSesion)}})};NodoClienteHTTP.prototype.enviarYRecibirMensajes=function(){var _this=this;var cant_mensajes_a_enviar;var bandejaSalidaAux=[];cant_mensajes_a_enviar=this.bandejaSalida.length;if(cant_mensajes_a_enviar>=this.mensajes_por_paquete)cant_mensajes_a_enviar=this.mensajes_por_paquete;bandejaSalidaAux=this.bandejaSalida.splice(0,cant_mensajes_a_enviar);var datosSalida={contenidos:bandejaSalidaAux,proximaEsperaMinima:0,proximaEsperaMaxima:3e5};if(bandejaSalidaAux.length>0){if(_this.verbose)console.log("enviando:",bandejaSalidaAux)}$.ajax({type:"POST",url:_this.url+"/session/"+_this.idSesion,xhrFields:{withCredentials:false},data:{mensajes_vortex:JSON.stringify(datosSalida)},success:function(responseData,textStatus,jqXHR){var mensajesRecibidos=$.parseJSON(responseData).contenidos;mensajesRecibidos.forEach(function(element,index,array){if(_this.verbose)console.log("mensaje recibido:",element);_this.vecino.recibirMensaje(element,_this)});setTimeout(function(){_this.enviarYRecibirMensajes()},_this.intervaloPolling)},error:function(request,error){console.log("error Al Enviar/Recibir Mensajes:",error);setTimeout(function(){_this.pedirIdSesion()},_this.intervaloPedidoIdSesion);_this.bandejaSalida=bandejaSalidaAux.concat(_this.bandejaSalida)}})};NodoClienteHTTP.prototype.recibirMensaje=function(un_mensaje){this.bandejaSalida.push(un_mensaje)};NodoClienteHTTP.prototype.conectarCon=function(un_vecino){if(this.vecino===un_vecino)return;this.vecino=un_vecino;un_vecino.conectarCon(this)};if(typeof require!="undefined"){exports.clase=NodoClienteHTTP}if(typeof require!="undefined"){var NodoNulo=require("./NodoNulo").clase;var io=require("socket.io")}var NodoConectorSocket=function(opt){this.socket=opt.socket||io.connect(opt);this.verbose=opt.verbose||false;this.id=opt.id||"anonimo";this.alDesconectar=opt.alDesconectar||function(){};this.vecino=new NodoNulo;var _this=this;this.socket.on("mensaje_vortex",function(mensaje){if(_this.verbose)console.log("conector recibe mensaje por socket:",mensaje);_this.vecino.recibirMensaje(mensaje,_this)});this.socket.on("disconnect",function(){_this.desconectarDe(_this.vecino)});if(this.verbose)console.log("socket "+this.id+" conectado")};NodoConectorSocket.prototype.conectarCon=function(un_vecino){if(this.vecino===un_vecino)return;this.vecino=un_vecino;un_vecino.conectarCon(this)};NodoConectorSocket.prototype.desconectarDe=function(un_nodo){this.vecino=new NodoNulo;this.desconectarDe=function(){};un_nodo.desconectarDe(this);if(this.verbose)console.log("socket "+this.id+" desconectado");this.alDesconectar()};NodoConectorSocket.prototype.recibirMensaje=function(mensaje){if(this.verbose)console.log("conector envia mensaje por socket:",mensaje);this.socket.emit("mensaje_vortex",mensaje)};if(typeof require!="undefined"){exports.clase=NodoConectorSocket}var NodoNulo=function(){};NodoNulo.prototype.recibirMensaje=function(){};NodoNulo.prototype.conectarCon=function(){};NodoNulo.prototype.desconectarDe=function(){};if(typeof require!="undefined"){exports.clase=NodoNulo}if(typeof require!="undefined"){var NodoRouter=require("./NodoRouter").clase;exports.Filtros=require("./Filtros");exports.NodoRouter=NodoRouter;exports.NodoConectorSocket=require("./NodoConectorSocket").clase;exports.NodoSesionHTTP=require("./NodoSesionHTTP").clase;exports.ServerHTTP=require("./ServerHTTP").clase;exports.ServerWebSockets=require("./ServerWebSockets").clase;exports.ServerVortex=require("./ServerVortex").clase}var Vx=new NodoRouter;if(typeof require!="undefined"){exports.Vx=Vx}